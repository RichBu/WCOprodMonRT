<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title>WCO Production Monitor</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<!--  Designed by Rich Budek @  www.RichBudek.com -->
		<!--  all rights reserved by Rich Budek -->
		<meta name="description" content="WCO Production Monitor">
		<meta name="author" content="Rich Budek">
		<meta name="author_website" content="www.RichBudek.com">
		<meta name="copyright" content="Rich Budek at www.RichBudek.com all rights reserved">
		<meta name='design package' content="Rich Budek crooked little fingers">
        <!--    -->

        <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.3.0/handlebars.js"></script>


        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
           crossorigin="anonymous">

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r"
            crossorigin="anonymous">

        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
          crossorigin="anonymous"></script>

		<link rel='stylesheet' type='text/css' href='/css/calc_oval.css'>
	</head>

	<body>
        <noscript>
          You need to enable JavaScript to run this app.
        </noscript>
        <header class="container text-center">
            <div class="row" style="padding: 20px 0px 0px 0px;" >
				<!--Site Logo-->
                <div class="col-sm-1 ol-xs-2">
  			      	<button id="btn-back" type="button" class="btn btn-primary leftButton" >&nbsp;&nbsp;&nbsp;&#60;&nbsp;&nbsp;&nbsp;</button>
                </div>
                <div class="col-sm-10 col-xs-7">
                    <h2>Read RT data</h2>
                </div>
                <div class="col-sm-1 col-xs-2">
  			      <button id="btn-about" type="button" class="btn btn-primary aboutButton" >Help</button>
                </div>
            </div>
			<hr/>
        </header>
		<div class="backgroundIndexStyle">
		</div>
		<div style="padding: 40px 0px 40px 0px;">
  			<div class="col-lg-1 col-md-2 col-sm-2 col-xs-1 transDivStyle">
			</div>
			<div class="col-lg-10 col-md-8 col-sm-8 col-xs-10 inputDivStyle">
				<div class="row">
					<button id="btn-startRead" class="calcButton btn btn-primary" >Start Reading</button>	
					<br/>
					<button id="btn-stopRead" class="calcButton btn btn-primary" >Stop Reading</button>	
					<br/>
					<br/>
					<br/><h3>&nbsp</h3>
				</div>				
				<div class="row">
				</div>
				<!-- Status Output -->
				<div id="outputDiv_head" class="row">
					<h5>click on picture for more information</h5>
				</div>
				<div id="outputDiv" class="row">
					<div id="M01" class="statusOff blockPic" data-pic="01"><h3>&nbsp&nbsp&nbsp&nbsp&nbsp01</h3></div>
					<div id="M02" class="statusOn  blockPic" data-pic="02"><h3>&nbsp&nbsp&nbsp&nbsp&nbsp02</h3></div>
					<div id="M03" class="statusOn  blockPic" data-pic="03"><h3>&nbsp&nbsp&nbsp&nbsp&nbsp03</h3></div>
					<div id="M04" class="statusRun blockPic" data-pic="04"><h3>&nbsp&nbsp&nbsp&nbsp&nbsp04</h3></div>
					<div id="M05" class="statusOff blockPic" data-pic="05"><h3>&nbsp&nbsp&nbsp&nbsp&nbsp05</h3></div>
					<div id="M06" class="statusOff blockPic" data-pic="06"><h3>&nbsp&nbsp&nbsp&nbsp&nbsp06</h3></div>
					<div id="M07" class="statusOff blockPic" data-pic="07"><h3>&nbsp&nbsp&nbsp&nbsp&nbsp07</h3></div>
					<div id="M08" class="statusOff blockPic" data-pic="08"><h3>&nbsp&nbsp&nbsp&nbsp&nbsp08</h3></div>
					<div id="M09" class="statusOff blockPic" data-pic="09"><h3>&nbsp&nbsp&nbsp&nbsp&nbsp09</h3></div>
				</div>	
				<div id="outputDiv_foot" class="row">
					<h5>click on picture for more information</h5>
				</div>
				<!-- Machine Data Output -->
				<div id="machineDiv" class="row">
				</div>	
				<div class="row">
					<br/>
					<br/>
					<div id="lastUpdate"></div>
				</div>	
				<div class="row">
					<div id="diffUpdate"></div>
				</div>	
				<div class="row">
					<div id="tmrUpdate"></div>
				</div>	
				<div class="row">
					<br/>
					<br/>
					<h3>&nbsp;<br/></h3>
				</div>	
			</div>
  			<div class="col-lg-1 col-md-2 col-sm-2 col-xs-1 transDivStyle">
			</div>
		</div>
        <!--Footer-->
        <!-- <footer class="container"> -->
        <div class="text-center navbar navbar-fixed-bottom" id='footer'>
            <div class="container-fluid">
                <br/>
                <span id='copyright'>Â© 2020 Copyright by Rich Budek all rights reserved</span>
            </div>
        </div>
        <!-- </footer> -->

		<!-- Modal about about -->
		<div id="modal-about" class="modal">
			<div class="modal-content">
				<h3>WCO Production Monitoring</h3>
				<div class="divider"></div>
				<h4>
					<br/>This page keeps polling the backend every 10 seconds once you 
					press the Start Reading button.  It will keep reading until you 
					press the Stop Reading button.  To conserve battery power and data 
					usage, press the Stop Reading button
					<br/>
					<br/>
					<br/>Legend:
					<br/>&nbsp;&nbsp;white = off line (no connection)
					<br/>&nbsp;&nbsp;red = stopped 
					<br/>&nbsp;&nbsp;green = running and feeding
					<br/>
					<br/>
					<br/>Software developed by Rich Budek by reusing code from other projects 
					for other users. 
					<br/>
					<br/>
				</h4>
				<div style="padding: 20px 0px 10px 0px;"  class="divider">
					<button id="close-about" type="button" class="btn btn-primary closeButton" data-dismiss="modal">Close</button>
					<button id="btn-exit" type="button" class="btn btn-primary exitButton" data-dismiss="modal">&nbspExit&nbsp</button>
					<br/><br/>
				</div>
				
				</div>
			</div>
		</div>


		<script>
		var tmrHandle = 0;
		var tmrEndVal = 6;
		var tmrCounts = 0;

		var closeModals = function() {
			var modAbout = $("#modal-about");
			$(modAbout).css("display", "none");		
			var modHelp1 = $("#modal-help1");
			$(modHelp1).css("display", "none");		
			var modHelp2 = $("#modal-help2");
			$(modHelp2).css("display", "none");		
			var modHelp3 = $("#modal-help3");
			$(modHelp3).css("display", "none");	
			//used to reload the page, don't want right now
			//because it clears all of the entries	
			//window.location.reload(false);
		};



		var tmrClick = function() {
			tmrCounts = tmrCounts + 1;
			$("#tmrUpdate").html("<h4>Seconds to refresh: " + (tmrEndVal-tmrCounts) + "</h4>");
			if (tmrCounts == tmrEndVal) {
				tmrCounts = 0;
				readData();
			};
		};

		var displayDiv = function(divType) {
			//turn on divs based on value passed in
			//0=all off  1=all  2=single machine
			console.log("display " + divType);
			switch (divType) {
				case 0: 
					$('#outputDiv').removeClass('showDiv');
					$('#outputDiv').addClass('hideDiv');
					$('#outputDiv_head').removeClass('showDiv');
					$('#outputDiv_head').addClass('hideDiv');
					$('#outputDiv_foot').removeClass('showDiv');
					$('#outputDiv_foot').addClass('hideDiv');
					$('#machineDiv').removeClass('showDiv');
					$('#machineDiv').addClass('hideDiv');
					dispType = 0;
					break;
				case 1:
					$('#outputDiv').removeClass('hideDiv');
					$('#outputDiv').addClass('showDiv');
					$('#outputDiv_head').removeClass('hideDiv');
					$('#outputDiv_head').addClass('showDiv');
					$('#outputDiv_foot').removeClass('hideDiv');
					$('#outputDiv_foot').addClass('showDiv');
					$('#machineDiv').removeClass('showDiv');
					$('#machineDiv').addClass('hideDiv');
					dispType = 1;
					break;
				case 2:
					$('#outputDiv').removeClass('showDiv');
					$('#outputDiv').addClass('hideDiv');
					$('#outputDiv_head').removeClass('showDiv');
					$('#outputDiv_head').addClass('hideDiv');
					$('#outputDiv_foot').removeClass('showDiv');
					$('#outputDiv_foot').addClass('hideDiv');
					$('#machineDiv').removeClass('hideDiv');
					$('#machineDiv').addClass('showDiv');
					dispType = 2;
					break;
			};
		};


		var readData = function() {
			  var data = "";
			  var url = "/api/read-rt-data";
			  $.post(url, data, function(data) {
				console.log("got read result");
				//console.log(data);
				for (var i=0; i<data.length; i++) {
					if (data[i].mach_num.trim() == "98" || data[i].mach_num.trim() == "99") {
						//this is the update time
						if (data[i].mach_num.trim() == "98") {
							//this is the difference
							$("#diffUpdate").html("<h4>Hours since upload: " + data[i].mach_stat_code + "</h4>");
						};
						if (data[i].mach_num.trim() == "99") {
							//this is the last update
							$("#lastUpdate").html("<h4>Last upload: " + data[i].mach_stat_code + "</h4>");
						};
					} else {
						//a machine update 
						var idStr = "#M" + data[i].mach_num.trim();
						$(idStr).removeClass();
						var statusStr = "";
						switch (data[i].mach_stat_code) {
							case "00":
						  		statusStr = "statusOff"; 
						  		break;
							case "01":
						  		statusStr = "statusOn";
						  		break;
							case "03":
						  		statusStr = "statusRun";
						  		break;
							case "09":
						  		statusStr = "statusHold";
						  	break;    
						};
						$(idStr).addClass(statusStr);
					};
				};
			  });
		};  // readData function



  	    $(document).ready(function () {
		  //document is ready, so move the incoming data over
          //closeModals();
			console.log("document is ready");

    	  //$(document.body).on("click", "#close-about", closeModals() );
		  $('#close-about').on('click', function(event) {
			  event.preventDefault();
			  closeModals();
		  });

		  $('#btn-back').on('click', function (event) {
			  event.preventDefault();
			  window.history.back();
		  });

		  $('#btn-about').on('click', function (event) {
			  event.preventDefault();
			  var modAbout = $("#modal-about");
			  $(modAbout).css("display", "block");
		  });


		  $('#btn-exit').on('click', function (event) {
			  event.preventDefault();
			  window.location.href = "http://www.msn.com";
		  });


		  //close the help modals by using a class
		  $('.close-help').on('click', function(event) {
			  event.preventDefault();
			  closeModals();
		  });

		  $('.exit-help').on('click', function (event) {
			  event.preventDefault();
			  closeModals();
			  window.location.href = "http://www.msn.com";
		  });


		  $('#btn-startRead').on('click', function (event) {
			  event.preventDefault();
			  console.log("clicked read button");
			  tmrCounts = 0;
			  tmrHandle = setInterval(tmrClick,1000);  //2000 or 2 secs is about min can do
			  readData();
		  });


		  $('#btn-stopRead').on('click', function (event) {
			  event.preventDefault();
			  console.log("clicked pause button");
			  clearInterval(tmrHandle);
			  for (var i=0; i<9; i++) {
				var machNum = i+1;  
				var idStr = "#M0" + machNum.toString().trim();
				$(idStr).removeClass();
				var statusStr = "statusOff";
				$(idStr).addClass(statusStr);
				};
		  });

			$('#monitor-form').submit(function(event){	
        		event.preventDefault();

				console.log("hit the write button");
				var data = $(this).serialize();
				var url = $(this).attr("action");
				$.post(url, data, function(data) {
					console.log("got result");
				});
    		});  //end of click			
 

			$('#machineDiv').on('click', function (event) {
				event.preventDefault();
				displayDiv(1);  //disp full table
			});


			$('.blockPic').on('click', function (event) {
				event.preventDefault();
				currMach = $(this).attr("data-pic");
				//clear the div first before displaying it
				console.log("clicked on block " + currMach);
				$("#machineDiv").html("");
				displayDiv(2);  //disp one machine
				readData();
			});

			displayDiv(1); //display all machines

  	    });

		</script>
	</body>

</html>